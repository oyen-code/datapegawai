<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ASN Monitor - KGB & Pangkat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
      }
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1; 
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8; 
      }
      @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .animate-fade-in {
        animation: fade-in 0.3s ease-out;
      }
      @keyframes slide-in {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      .animate-slide-in {
        animation: slide-in 0.3s ease-out;
      }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "react-router-dom": "https://esm.sh/react-router-dom@6.22.3",
    "lucide-react": "https://esm.sh/lucide-react@0.363.0",
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.39.8",
    "xlsx": "https://esm.sh/xlsx@0.18.5",
    "recharts": "https://esm.sh/recharts@2.12.3",
    "react/": "https://esm.sh/react@^19.2.4/",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/"
  }
}
</script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="typescript,react">
      import React, { useState, useEffect, useMemo, useRef, useCallback, createContext, useContext } from 'react';
      import ReactDOM from 'react-dom/client';
      import { HashRouter, Routes, Route, Link, useLocation, Navigate, Outlet, useNavigate } from 'react-router-dom';
      import { createClient } from '@supabase/supabase-js';
      import * as XLSX from 'xlsx';
      import { 
        LayoutDashboard, Users, Bell, Menu, FileText, BarChart2, Briefcase, Award, 
        CheckCircle, AlertTriangle, Info, LogOut, Loader2, FolderOpen, 
        Clock, AlertCircle, Edit, Save, X, Search, Filter, ChevronLeft, ChevronRight, 
        Download, Upload, FileSpreadsheet, ExternalLink, ArrowRight, UserPlus, Lock, Mail, LogIn 
      } from 'lucide-react';
      import { 
        PieChart, Pie, Cell, Tooltip as RechartsTooltip, ResponsiveContainer, 
        BarChart, Bar, XAxis, YAxis, CartesianGrid 
      } from 'recharts';

      // --- CONFIGURATION ---
      const SUPABASE_URL = 'https://qcmbwjaivnqeuifwkxzf.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjbWJ3amFpdm5xZXVpZndreHpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDU2NjgsImV4cCI6MjA4NjI4MTY2OH0.rHgEdXzgqZlx4BL_LlADp4f7-yoAhw4OsXcYj25I7hw';
      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

      // --- UTILS ---
      const formatDate = (date) => {
        if (!date) return '-';
        const d = new Date(date);
        if (isNaN(d.getTime())) return '-';
        return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
      };

      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
      };

      const calculateNextDate = (lastTmt, type) => {
        const date = new Date(lastTmt);
        const yearsToAdd = type === 'KGB' ? 2 : 4;
        date.setFullYear(date.getFullYear() + yearsToAdd);
        return date;
      };

      const exportToExcel = (data, fileName) => {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        const dateStr = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `${fileName}_${dateStr}.xlsx`);
      };

      const readExcelFile = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target?.result);
              const workbook = XLSX.read(data, { type: 'array', cellDates: true });
              const sheetName = workbook.SheetNames[0];
              const sheet = workbook.Sheets[sheetName];
              const json = XLSX.utils.sheet_to_json(sheet);
              resolve(json);
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = (error) => reject(error);
          reader.readAsArrayBuffer(file);
        });
      };

      // --- SERVICES (Flattened) ---
      // Auth
      const signUp = async (email, password) => {
        const { data, error } = await supabase.auth.signUp({ email, password });
        return { data, error };
      };
      const signIn = async (email, password) => {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        return { data, error };
      };
      const signOut = async () => {
        const { error } = await supabase.auth.signOut();
        return { error };
      };

      // Storage
      const getPositions = async () => {
        const { data, error } = await supabase.from('positions').select('*');
        if (error) console.error(error);
        return data || [];
      };
      const savePosition = async (item) => {
        const { error } = await supabase.from('positions').upsert(item);
        if (error) throw error;
        return getPositions();
      };
      const deletePosition = async (id) => {
        const { error } = await supabase.from('positions').delete().eq('id', id);
        if (error) throw error;
        return getPositions();
      };

      const getRanks = async () => {
        const { data, error } = await supabase.from('ranks').select('*');
        if (error) console.error(error);
        return data || [];
      };
      const saveRank = async (item) => {
        const { error } = await supabase.from('ranks').upsert(item);
        if (error) throw error;
        return getRanks();
      };
      const deleteRank = async (id) => {
        const { error } = await supabase.from('ranks').delete().eq('id', id);
        if (error) throw error;
        return getRanks();
      };

      const getEmployees = async (onlyActive = false) => {
        let query = supabase.from('employees').select('*');
        if (onlyActive) query = query.eq('isActive', true);
        const { data, error } = await query;
        if (error) console.error(error);
        return data || [];
      };
      const saveEmployee = async (item) => {
        const dbPayload = {
          id: item.id,
          nip: item.nip,
          name: item.name,
          positionId: item.positionId,
          rankId: item.rankId || null,
          isActive: item.isActive,
          createdAt: item.createdAt
        };
        const { error } = await supabase.from('employees').upsert(dbPayload);
        if (error) throw new Error(error.message);
        return getEmployees();
      };
      const deleteEmployee = async (id) => {
        const { error } = await supabase.from('employees').delete().eq('id', id);
        if (error) throw error;
        return getEmployees();
      };

      const getSKs = async (type, employeeId) => {
        let query = supabase.from('sks').select('*');
        if (type) query = query.eq('type', type);
        if (employeeId) query = query.eq('employeeId', employeeId);
        const { data, error } = await query;
        if (error) console.error(error);
        const list = data || [];
        return list.sort((a, b) => new Date(b.tmtDate).getTime() - new Date(a.tmtDate).getTime());
      };
      const saveSK = async (item) => {
        const { error } = await supabase.from('sks').upsert(item);
        if (error) throw error;
        if (item.type === 'PANGKAT') {
          await supabase.from('employees').update({ rankId: item.rankId }).eq('id', item.employeeId);
        }
        return getSKs(item.type);
      };
      const deleteSK = async (id) => {
        const { data } = await supabase.from('sks').select('type').eq('id', id).single();
        const type = data?.type;
        const { error } = await supabase.from('sks').delete().eq('id', id);
        if (error) throw error;
        return getSKs(type);
      };

      const getMonitoringNotes = async () => {
        const { data, error } = await supabase.from('monitoring_notes').select('*');
        if (error) console.error(error);
        return data || [];
      };
      const saveMonitoringNote = async (note) => {
        const { error } = await supabase.from('monitoring_notes').upsert(note);
        if (error) throw error;
        return getMonitoringNotes();
      };

      // --- CONTEXT ---
      const DataContext = createContext(undefined);

      const DataProvider = ({ children }) => {
        const [employees, setEmployees] = useState([]);
        const [sks, setSks] = useState([]);
        const [ranks, setRanks] = useState([]);
        const [positions, setPositions] = useState([]);
        const [monitoringNotes, setMonitoringNotes] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [session, setSession] = useState(null);

        useEffect(() => {
          supabase.auth.getSession().then(({ data: { session } }) => setSession(session));
          const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => setSession(session));
          return () => subscription.unsubscribe();
        }, []);

        const refreshData = useCallback(async () => {
          if (!session) {
            setIsLoading(false);
            return;
          }
          setIsLoading(true);
          try {
            const [empData, skData, rankData, posData, noteData] = await Promise.all([
              getEmployees(),
              getSKs(),
              getRanks(),
              getPositions(),
              getMonitoringNotes()
            ]);
            setEmployees(empData);
            setSks(skData);
            setRanks(rankData);
            setPositions(posData);
            setMonitoringNotes(noteData);
          } catch (error) {
            console.error("Failed to fetch data", error);
          } finally {
            setIsLoading(false);
          }
        }, [session]);

        useEffect(() => {
          refreshData();
        }, [refreshData]);

        return (
          <DataContext.Provider value={{ employees, sks, ranks, positions, monitoringNotes, isLoading, refreshData }}>
            {children}
          </DataContext.Provider>
        );
      };

      const useData = () => {
        const context = useContext(DataContext);
        if (context === undefined) throw new Error('useData must be used within a DataProvider');
        return context;
      };

      // --- COMPONENTS ---

      // ConfirmModal
      const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
        if (!isOpen) return null;
        return (
          <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in p-4">
            <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100">
              <div className="flex flex-col items-center text-center">
                <div className="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mb-4">
                  <AlertTriangle className="text-red-600" size={24} />
                </div>
                <h3 className="text-lg font-bold text-gray-900 mb-2">{title}</h3>
                <p className="text-sm text-gray-500 mb-6">{message}</p>
                <div className="flex gap-3 w-full">
                  <button onClick={onCancel} className="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors">Batal</button>
                  <button onClick={onConfirm} className="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors shadow-sm">Hapus</button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // EmployeeForm
      const EmployeeForm = ({ isOpen, initialData, positions, onClose, onSave }) => {
        const [formData, setFormData] = useState({ name: '', nip: '', positionId: '', isActive: true });
        useEffect(() => {
          if (isOpen) {
            setFormData(initialData || { id: undefined, name: '', nip: '', positionId: '', isActive: true });
          }
        }, [isOpen, initialData]);

        if (!isOpen) return null;

        const handleSubmit = (e) => {
          e.preventDefault();
          if (!formData.name || !formData.nip || !formData.positionId) return;
          const selectedPosition = positions.find(p => p.id === formData.positionId);
          const newEmployee = {
            id: formData.id || crypto.randomUUID(),
            name: formData.name,
            nip: formData.nip,
            positionId: formData.positionId,
            position: selectedPosition ? selectedPosition.name : '',
            createdAt: formData.createdAt || Date.now(),
            isActive: formData.isActive ?? true
          };
          onSave(newEmployee);
          onClose();
        };

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in">
            <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
              <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h2 className="text-xl font-bold text-gray-800">{initialData ? 'Edit Data Pegawai' : 'Tambah Pegawai Baru'}</h2>
                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors"><X size={24} /></button>
              </div>
              <form onSubmit={handleSubmit} className="p-6 overflow-y-auto space-y-4">
                <div><label className="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label><input type="text" required className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} /></div>
                <div><label className="block text-sm font-medium text-gray-700 mb-1">NIP</label><input type="number" required className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={formData.nip || ''} onChange={e => setFormData({...formData, nip: e.target.value})} /></div>
                <div><label className="block text-sm font-medium text-gray-700 mb-1">Jabatan</label><select required className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white" value={formData.positionId || ''} onChange={e => setFormData({...formData, positionId: e.target.value})}><option value="">- Pilih Jabatan -</option>{positions.map(p => (<option key={p.id} value={p.id}>{p.name}</option>))}</select></div>
                <div><label className="block text-sm font-medium text-gray-700 mb-1">Status Pegawai</label><select className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white" value={formData.isActive ? 'active' : 'inactive'} onChange={e => setFormData({...formData, isActive: e.target.value === 'active'})}><option value="active">Aktif</option><option value="inactive">Non-Aktif / Pensiun / Pindah</option></select></div>
                <div className="pt-4"><button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2"><Save size={20} /> Simpan Data</button></div>
              </form>
            </div>
          </div>
        );
      };

      // Login
      const Login = ({ notify }) => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [loading, setLoading] = useState(false);
        const navigate = useNavigate();

        const handleLogin = async (e) => {
          e.preventDefault();
          setLoading(true);
          const { error } = await signIn(email, password);
          if (error) {
            notify(error.message, 'error');
          } else {
            notify('Login berhasil!', 'success');
            navigate('/');
          }
          setLoading(false);
        };

        return (
          <div className="min-h-screen bg-gray-50 flex flex-col justify-center items-center p-4">
            <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden">
              <div className="p-8">
                <div className="text-center mb-8">
                  <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><Lock className="w-8 h-8 text-blue-600" /></div>
                  <h2 className="text-2xl font-bold text-gray-900">Selamat Datang</h2>
                  <p className="text-gray-500 text-sm mt-2">Silakan login untuk mengakses Sistem Monitoring ASN</p>
                </div>
                <form onSubmit={handleLogin} className="space-y-6">
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">Email</label><div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Mail className="h-5 w-5 text-gray-400" /></div><input type="email" required className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="nama@email.com" value={email} onChange={(e) => setEmail(e.target.value)} /></div></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">Password</label><div className="relative"><div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Lock className="h-5 w-5 text-gray-400" /></div><input type="password" required className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} /></div></div>
                  <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 rounded-lg shadow-md flex items-center justify-center gap-2 disabled:opacity-70">{loading ? <Loader2 className="animate-spin" size={20} /> : <LogIn size={20} />} Login</button>
                </form>
                <div className="mt-6 text-center text-sm text-gray-600">Belum punya akun? <Link to="/register" className="text-blue-600 hover:underline font-medium">Daftar disini</Link></div>
              </div>
            </div>
          </div>
        );
      };

      // Register
      const Register = ({ notify }) => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [confirmPassword, setConfirmPassword] = useState('');
        const [loading, setLoading] = useState(false);
        const navigate = useNavigate();

        const handleRegister = async (e) => {
          e.preventDefault();
          if (password !== confirmPassword) return notify('Password konfirmasi tidak cocok', 'error');
          if (password.length < 6) return notify('Password minimal 6 karakter', 'error');
          setLoading(true);
          const { error } = await signUp(email, password);
          if (error) {
            notify(error.message, 'error');
          } else {
            notify('Pendaftaran berhasil! Silakan login.', 'success');
            navigate('/login');
          }
          setLoading(false);
        };

        return (
          <div className="min-h-screen bg-gray-50 flex flex-col justify-center items-center p-4">
            <div className="max-w-md w-full bg-white rounded-2xl shadow-xl overflow-hidden">
              <div className="p-8">
                <div className="text-center mb-8">
                  <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4"><UserPlus className="w-8 h-8 text-emerald-600" /></div>
                  <h2 className="text-2xl font-bold text-gray-900">Buat Akun Baru</h2>
                  <p className="text-gray-500 text-sm mt-2">Daftar untuk mengakses sistem</p>
                </div>
                <form onSubmit={handleRegister} className="space-y-5">
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" required className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={email} onChange={(e) => setEmail(e.target.value)} /></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" required minLength={6} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={password} onChange={(e) => setPassword(e.target.value)} /></div>
                  <div><label className="block text-sm font-medium text-gray-700 mb-1">Konfirmasi Password</label><input type="password" required className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} /></div>
                  <button type="submit" disabled={loading} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2.5 rounded-lg shadow-md flex items-center justify-center gap-2 disabled:opacity-70">{loading ? <Loader2 className="animate-spin" size={20} /> : <UserPlus size={20} />} Daftar Sekarang</button>
                </form>
                <div className="mt-6 text-center text-sm text-gray-600">Sudah punya akun? <Link to="/login" className="text-blue-600 hover:underline font-medium">Login disini</Link></div>
              </div>
            </div>
          </div>
        );
      };

      // --- FEATURE COMPONENTS ---
      
      const Dashboard = () => {
        const { employees, sks } = useData();
        const activeEmployees = useMemo(() => employees.filter(e => e.isActive), [employees]);
        const { stats, chartData, urgentItems, nextYearProjection } = useMemo(() => {
          let kgbSafe = 0, kgbWarning = 0, kgbLate = 0;
          let rankSafe = 0, rankWarning = 0, rankLate = 0;
          const monthsMap = {};
          const today = new Date();
          today.setHours(0,0,0,0);
          for (let i = 0; i < 12; i++) {
            const d = new Date(today.getFullYear(), today.getMonth() + i, 1);
            const key = `${d.getFullYear()}-${d.getMonth()}`;
            const monthName = d.toLocaleDateString('id-ID', { month: 'short', year: '2-digit' });
            monthsMap[key] = { name: monthName, kgb: 0, rank: 0, sortKey: d.getTime() };
          }
          const urgentList = [];
          let projectedKgbCount = 0;
          let projectedRankCount = 0;
          const skMap = {};
          sks.forEach(sk => { if(!skMap[sk.employeeId]) skMap[sk.employeeId] = []; skMap[sk.employeeId].push(sk); });

          const calculateStatus = (targetDate) => {
            const diffTime = targetDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) return 'LATE';
            if (diffDays <= 90) return 'DUE';
            if (diffDays <= 180) return 'WARNING';
            return 'SAFE';
          };

          activeEmployees.forEach(emp => {
            const empSKs = skMap[emp.id] || [];
            const kgbSKs = empSKs.filter(s => s.type === 'KGB').sort((a,b) => new Date(b.tmtDate).getTime() - new Date(a.tmtDate).getTime());
            if (kgbSKs.length > 0) {
              const nextKgbDate = new Date(kgbSKs[0].tmtDate);
              nextKgbDate.setFullYear(nextKgbDate.getFullYear() + 2);
              const status = calculateStatus(nextKgbDate);
              if (status === 'LATE') { kgbLate++; urgentList.push({ id: emp.id+'kgb', name: emp.name, nip: emp.nip, type: 'KGB', date: nextKgbDate, status: 'LATE' }); }
              else if (status === 'DUE') { kgbWarning++; urgentList.push({ id: emp.id+'kgb', name: emp.name, nip: emp.nip, type: 'KGB', date: nextKgbDate, status: 'DUE' }); }
              else if (status === 'WARNING') kgbWarning++;
              else kgbSafe++;
              const key = `${nextKgbDate.getFullYear()}-${nextKgbDate.getMonth()}`;
              if (monthsMap[key]) monthsMap[key].kgb++;
              const diffDays = Math.ceil((nextKgbDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
              if (diffDays > 0 && diffDays <= 365) projectedKgbCount++;
            }
            const rankSKs = empSKs.filter(s => s.type === 'PANGKAT').sort((a,b) => new Date(b.tmtDate).getTime() - new Date(a.tmtDate).getTime());
            if (rankSKs.length > 0) {
              const nextRankDate = new Date(rankSKs[0].tmtDate);
              nextRankDate.setFullYear(nextRankDate.getFullYear() + 4);
              const status = calculateStatus(nextRankDate);
              if (status === 'LATE') { rankLate++; urgentList.push({ id: emp.id+'rank', name: emp.name, nip: emp.nip, type: 'PANGKAT', date: nextRankDate, status: 'LATE' }); }
              else if (status === 'DUE') { rankWarning++; urgentList.push({ id: emp.id+'rank', name: emp.name, nip: emp.nip, type: 'PANGKAT', date: nextRankDate, status: 'DUE' }); }
              else if (status === 'WARNING') rankWarning++;
              else rankSafe++;
              const key = `${nextRankDate.getFullYear()}-${nextRankDate.getMonth()}`;
              if (monthsMap[key]) monthsMap[key].rank++;
              const diffDays = Math.ceil((nextRankDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
              if (diffDays > 0 && diffDays <= 365) projectedRankCount++;
            }
          });
          urgentList.sort((a, b) => {
             const priority = { 'LATE': 0, 'DUE': 1, 'WARNING': 2 };
             if (priority[a.status] !== priority[b.status]) return priority[a.status] - priority[b.status];
             return a.date.getTime() - b.date.getTime();
          });
          return { stats: { kgbSafe, kgbWarning, kgbLate, rankSafe, rankWarning, rankLate }, chartData: Object.values(monthsMap).sort((a, b) => a.sortKey - b.sortKey), urgentItems: urgentList.slice(0, 5), nextYearProjection: { kgb: projectedKgbCount, rank: projectedRankCount } };
        }, [activeEmployees, sks]);
        
        const kgbPieData = [{ name: 'Aman', value: stats.kgbSafe, color: '#10b981' }, { name: 'Mendekati', value: stats.kgbWarning, color: '#f59e0b' }, { name: 'Terlambat', value: stats.kgbLate, color: '#ef4444' }].filter(d => d.value > 0);
        const rankPieData = [{ name: 'Aman', value: stats.rankSafe, color: '#3b82f6' }, { name: 'Mendekati', value: stats.rankWarning, color: '#f59e0b' }, { name: 'Terlambat', value: stats.rankLate, color: '#ef4444' }].filter(d => d.value > 0);

        return (
          <div className="space-y-6 animate-fade-in pb-10">
            <div className="flex justify-between items-end"><div><h1 className="text-2xl font-bold text-gray-800">Dashboard Monitoring</h1><p className="text-gray-500 text-sm mt-1">Ringkasan status kepegawaian dan proyeksi beban kerja.</p></div><div className="text-right hidden sm:block"><div className="text-sm font-semibold text-gray-700">{new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</div></div></div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
               <StatCard icon={<Users className="w-6 h-6 text-blue-600" />} title="Total Pegawai" value={activeEmployees.length} subtitle="Pegawai Aktif" color="bg-white border-blue-100" />
               <StatCard icon={<FileText className="w-6 h-6 text-emerald-600" />} title="Proyeksi KGB" value={nextYearProjection.kgb} subtitle="12 Bulan Kedepan" color="bg-white border-emerald-100" />
               <StatCard icon={<Award className="w-6 h-6 text-purple-600" />} title="Proyeksi Pangkat" value={nextYearProjection.rank} subtitle="12 Bulan Kedepan" color="bg-white border-purple-100" />
               <StatCard icon={<AlertCircle className="w-6 h-6 text-red-600" />} title="Perlu Perhatian" value={stats.kgbLate + stats.rankLate + stats.kgbWarning + stats.rankWarning} subtitle="Terlambat / Tempo" color="bg-red-50 border-red-200" isAlert />
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
               <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                  <h3 className="text-lg font-bold text-gray-800 mb-6">Timeline Kenaikan (12 Bulan)</h3>
                  <div className="h-72"><ResponsiveContainer width="100%" height="100%"><BarChart data={chartData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" /><XAxis dataKey="name" tick={{fontSize: 11}} axisLine={false} tickLine={false} /><YAxis allowDecimals={false} tick={{fontSize: 11}} axisLine={false} tickLine={false} /><RechartsTooltip /><Bar dataKey="kgb" stackId="a" fill="#10b981" radius={[0, 0, 4, 4]} name="KGB" /><Bar dataKey="rank" stackId="a" fill="#3b82f6" radius={[4, 4, 0, 0]} name="Pangkat" /></BarChart></ResponsiveContainer></div>
               </div>
               <div className="space-y-6">
                  <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col h-[180px]"><h3 className="text-sm font-semibold text-gray-600 mb-2">Kesehatan KGB</h3><div className="flex-1 flex items-center"><div className="w-1/2 h-full"><ResponsiveContainer><PieChart><Pie data={kgbPieData} cx="50%" cy="50%" innerRadius={35} outerRadius={50} paddingAngle={2} dataKey="value">{kgbPieData.map((e, i) => <Cell key={i} fill={e.color} />)}</Pie><RechartsTooltip /></PieChart></ResponsiveContainer></div><div className="w-1/2 space-y-2 text-xs"><div>Aman <span className="font-bold text-emerald-600">{stats.kgbSafe}</span></div><div>Tempo <span className="font-bold text-amber-500">{stats.kgbWarning}</span></div><div>Telat <span className="font-bold text-red-500">{stats.kgbLate}</span></div></div></div></div>
                  <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col h-[180px]"><h3 className="text-sm font-semibold text-gray-600 mb-2">Kesehatan Pangkat</h3><div className="flex-1 flex items-center"><div className="w-1/2 h-full"><ResponsiveContainer><PieChart><Pie data={rankPieData} cx="50%" cy="50%" innerRadius={35} outerRadius={50} paddingAngle={2} dataKey="value">{rankPieData.map((e, i) => <Cell key={i} fill={e.color} />)}</Pie><RechartsTooltip /></PieChart></ResponsiveContainer></div><div className="w-1/2 space-y-2 text-xs"><div>Aman <span className="font-bold text-blue-600">{stats.rankSafe}</span></div><div>Tempo <span className="font-bold text-amber-500">{stats.rankWarning}</span></div><div>Telat <span className="font-bold text-red-500">{stats.rankLate}</span></div></div></div></div>
               </div>
            </div>
            <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
               <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-red-50"><h3 className="text-lg font-bold text-red-800 flex items-center gap-2"><AlertTriangle size={20}/> Prioritas Tindakan</h3><Link to="/monitoring" className="text-xs font-semibold text-red-600 flex items-center gap-1">Lihat Semua <ArrowRight size={14} /></Link></div>
               <div className="overflow-x-auto"><table className="w-full text-left"><thead className="bg-gray-50 text-gray-500 text-xs uppercase font-semibold"><tr><th className="p-4">Pegawai</th><th className="p-4">Jenis</th><th className="p-4">TMT</th><th className="p-4">Status</th><th className="p-4 text-center">Aksi</th></tr></thead><tbody className="divide-y divide-gray-100 text-sm">{urgentItems.length > 0 ? urgentItems.map(item => (<tr key={item.id} className="hover:bg-gray-50"><td className="p-4"><div className="font-semibold text-gray-900">{item.name}</div><div className="text-gray-500 text-xs">{item.nip}</div></td><td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold border ${item.type === 'KGB' ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-blue-50 text-blue-600 border-blue-100'}`}>{item.type}</span></td><td className="p-4 font-medium text-gray-700">{formatDate(item.date)}</td><td className="p-4">{item.status === 'LATE' ? <span className="text-red-600 font-bold text-xs flex items-center gap-1"><AlertCircle size={14}/> TERLAMBAT</span> : <span className="text-orange-600 font-bold text-xs flex items-center gap-1"><Clock size={14}/> TEMPO</span>}</td><td className="p-4 text-center"><Link to="/monitoring" className="text-blue-600 hover:underline text-xs">Proses</Link></td></tr>)) : <tr><td colSpan={5} className="p-8 text-center text-gray-500">Tidak ada tindakan mendesak.</td></tr>}</tbody></table></div>
            </div>
          </div>
        );
      };
      const StatCard = ({ icon, title, value, subtitle, color, isAlert }) => (
        <div className={`p-5 rounded-xl border ${color} shadow-sm transition-all hover:shadow-md ${isAlert ? 'bg-red-50' : 'bg-white'}`}>
           <div className="flex justify-between items-start"><div><p className={`text-sm font-medium ${isAlert ? 'text-red-600' : 'text-gray-500'}`}>{title}</p><h3 className={`text-3xl font-bold mt-2 ${isAlert ? 'text-red-700' : 'text-gray-800'}`}>{value}</h3></div><div className={`p-2 rounded-lg ${isAlert ? 'bg-red-100' : 'bg-gray-50'}`}>{icon}</div></div><p className={`text-xs mt-3 ${isAlert ? 'text-red-500' : 'text-gray-400'}`}>{subtitle}</p>
        </div>
      );

      const Monitoring = () => {
        const { employees, sks, ranks, monitoringNotes, refreshData } = useData();
        const [search, setSearch] = useState('');
        const [showSafe, setShowSafe] = useState(false);
        const [currentPage, setCurrentPage] = useState(1);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [currentEvent, setCurrentEvent] = useState(null);
        const [noteText, setNoteText] = useState('');
        const [isConfirmed, setIsConfirmed] = useState(false);
        const itemsPerPage = 10;

        useEffect(() => setCurrentPage(1), [search, showSafe]);

        const events = useMemo(() => {
          const activeEmployees = employees.filter(e => e.isActive);
          const generatedEvents = [];
          const skMap = {};
          sks.forEach(sk => { if(!skMap[sk.employeeId]) skMap[sk.employeeId] = []; skMap[sk.employeeId].push(sk); });
          activeEmployees.forEach(emp => {
             const rank = ranks.find(r => r.id === emp.rankId);
             const rankName = rank ? rank.name : '-';
             const golongan = rank ? rank.golongan : '-';
             const empSKs = skMap[emp.id] || [];
             const calculateStatus = (dueDate) => {
               const diffDays = Math.ceil((new Date(dueDate).setHours(0,0,0,0) - new Date().setHours(0,0,0,0)) / (1000 * 60 * 60 * 24));
               if (diffDays < 0) return 'TERLAMBAT';
               if (diffDays <= 90) return 'JATUH_TEMPO';
               if (diffDays <= 180) return 'MENDEKATI';
               return 'AMAN';
             };
             const processType = (type, yearsInterval) => {
               const typeSKs = empSKs.filter(sk => sk.type === type).sort((a,b) => new Date(b.tmtDate).getTime() - new Date(a.tmtDate).getTime());
               if(typeSKs.length > 0) {
                 const nextDate = new Date(typeSKs[0].tmtDate);
                 nextDate.setFullYear(nextDate.getFullYear() + yearsInterval);
                 const noteId = `${emp.id}_${type}_${nextDate.getFullYear()}`;
                 generatedEvents.push({ id: noteId, employeeId: emp.id, nip: emp.nip, name: emp.name, rankName, golongan, lastTmt: typeSKs[0].tmtDate, type, nextTmt: nextDate, status: calculateStatus(nextDate), noteData: monitoringNotes.find(n => n.id === noteId) });
               }
             };
             processType('KGB', 2); processType('PANGKAT', 4);
          });
          const statusPriority = { 'TERLAMBAT': 0, 'JATUH_TEMPO': 1, 'MENDEKATI': 2, 'AMAN': 3, 'SUDAH_SK': 4 };
          return generatedEvents.sort((a, b) => (statusPriority[a.status] - statusPriority[b.status]) || (a.nextTmt.getTime() - b.nextTmt.getTime()));
        }, [employees, sks, ranks, monitoringNotes]);

        const handleDownloadExcel = () => {
           const filtered = events.filter(ev => (ev.name.toLowerCase().includes(search.toLowerCase()) || ev.nip.includes(search)) && (showSafe || ev.status !== 'AMAN'));
           const data = filtered.map((item, i) => ({ No: i+1, Nama: item.name, NIP: item.nip, 'Pangkat/Gol': `${item.rankName} (${item.golongan})`, 'TMT Terakhir': formatDate(item.lastTmt), Jenis: item.type, 'Estimasi TMT': formatDate(item.nextTmt), Status: item.status, Catatan: item.noteData?.notes || '-', Confirmed: item.noteData?.isConfirmed?'Ya':'Tidak' }));
           exportToExcel(data, 'Monitoring_ASN');
        };

        const filteredEvents = events.filter(ev => (ev.name.toLowerCase().includes(search.toLowerCase()) || ev.nip.includes(search)) && (showSafe || ev.status !== 'AMAN'));
        const paginatedEvents = filteredEvents.slice((currentPage-1)*itemsPerPage, currentPage*itemsPerPage);

        const handleSaveNote = async () => {
          if (!currentEvent) return;
          const note = { id: currentEvent.id, employeeId: currentEvent.employeeId, type: currentEvent.type, year: currentEvent.nextTmt.getFullYear(), notes: noteText, isConfirmed: isConfirmed, updatedAt: Date.now() };
          await saveMonitoringNote(note);
          await refreshData();
          setIsModalOpen(false);
        };

        return (
          <div className="space-y-6">
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4"><div><h2 className="text-2xl font-bold text-gray-800">Monitoring Kenaikan</h2><p className="text-gray-500 text-sm mt-1">Daftar estimasi kenaikan berikutnya.</p></div><button onClick={handleDownloadExcel} className="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-emerald-700 transition shadow-sm"><Download size={18} /> Excel</button></div>
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col sm:flex-row gap-3"><div className="flex-1 flex items-center gap-2 border border-gray-200 rounded-lg px-3 py-2 bg-gray-50"><Search className="text-gray-400" size={20} /><input type="text" placeholder="Cari Nama atau NIP..." className="flex-1 outline-none text-gray-700 bg-transparent" value={search} onChange={e => setSearch(e.target.value)} /></div><label className="flex items-center gap-2 text-sm font-medium text-gray-600 cursor-pointer border border-gray-200 rounded-lg px-4 py-2"><input type="checkbox" checked={showSafe} onChange={e => setShowSafe(e.target.checked)} className="w-4 h-4" /> Tampilkan Aman</label></div>
            <div className="bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col"><div className="overflow-y-auto max-h-[60vh]"><table className="w-full text-left whitespace-nowrap"><thead className="bg-gray-50 text-gray-600 text-xs uppercase font-semibold sticky top-0"><tr><th className="p-4">No</th><th className="p-4">Pegawai</th><th className="p-4">Pangkat</th><th className="p-4">TMT Akhir</th><th className="p-4">Jenis</th><th className="p-4">Estimasi</th><th className="p-4">Status</th><th className="p-4">Catatan</th><th className="p-4">Aksi</th></tr></thead><tbody className="divide-y divide-gray-100 text-sm">{paginatedEvents.map((item, i) => (<tr key={item.id} className={`hover:bg-gray-50 ${item.noteData?.isConfirmed?'bg-green-50/30':''}`}><td className="p-4 text-center">{(currentPage-1)*itemsPerPage+i+1}</td><td className="p-4"><div>{item.name}</div><div className="text-xs text-gray-500">{item.nip}</div></td><td className="p-4"><div>{item.golongan}</div><div className="text-xs text-gray-400">{item.rankName}</div></td><td className="p-4">{formatDate(item.lastTmt)}</td><td className="p-4"><span className={`px-2 py-0.5 rounded text-[10px] font-bold ${item.type==='KGB'?'bg-blue-50 text-blue-600':'bg-purple-50 text-purple-600'}`}>{item.type}</span></td><td className="p-4 font-bold">{formatDate(item.nextTmt)}</td><td className="p-4">{item.status==='TERLAMBAT'?<span className="text-red-700 font-bold text-xs bg-red-100 px-2 py-1 rounded">Terlambat</span>:item.status==='JATUH_TEMPO'?<span className="text-orange-700 font-bold text-xs bg-orange-100 px-2 py-1 rounded">Tempo</span>:item.status==='MENDEKATI'?<span className="text-yellow-700 font-bold text-xs bg-yellow-100 px-2 py-1 rounded">Mendekati</span>:<span className="text-green-700 font-bold text-xs bg-green-100 px-2 py-1 rounded">Aman</span>}</td><td className="p-4 max-w-xs truncate text-xs">{item.noteData?.notes}</td><td className="p-4 text-center"><button onClick={() => { setCurrentEvent(item); setNoteText(item.noteData?.notes||''); setIsConfirmed(item.noteData?.isConfirmed||false); setIsModalOpen(true); }} className="p-2 border rounded hover:bg-gray-50"><Edit size={16}/></button></td></tr>))}</tbody></table></div></div>
            {isModalOpen && currentEvent && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"><div className="bg-white rounded-xl shadow-2xl max-w-md w-full"><div className="p-4 border-b flex justify-between"><h3>Konfirmasi</h3><button onClick={()=>setIsModalOpen(false)}><X size={20}/></button></div><div className="p-6 space-y-4"><div className="bg-blue-50 p-3 rounded text-sm text-blue-800"><b>{currentEvent.name}</b><br/>{currentEvent.type} • {formatDate(currentEvent.nextTmt)}</div><textarea className="w-full p-3 border rounded" placeholder="Catatan..." value={noteText} onChange={e=>setNoteText(e.target.value)} /><label className="flex gap-2 items-center"><input type="checkbox" checked={isConfirmed} onChange={e=>setIsConfirmed(e.target.checked)} /> Tandai Dikonfirmasi</label></div><div className="p-4 border-t flex gap-3"><button onClick={()=>setIsModalOpen(false)} className="flex-1 py-2 border rounded">Batal</button><button onClick={handleSaveNote} className="flex-1 py-2 bg-blue-600 text-white rounded">Simpan</button></div></div></div>)}
          </div>
        );
      };

      const EmployeeList = ({ notify }) => {
        const { employees, positions, refreshData } = useData();
        const [search, setSearch] = useState('');
        const [currentPage, setCurrentPage] = useState(1);
        const [isModalOpen, setIsModalOpen] = useState(false);
        const [editingEmp, setEditingEmp] = useState(null);
        const [deleteId, setDeleteId] = useState(null);
        const fileInputRef = useRef(null);
        const itemsPerPage = 10;
        useEffect(() => setCurrentPage(1), [search]);

        const filtered = employees.filter(e => e.name.toLowerCase().includes(search.toLowerCase()) || e.nip.includes(search));
        const paginated = filtered.slice((currentPage-1)*itemsPerPage, currentPage*itemsPerPage);

        const handleSave = async (data) => {
          const isDup = employees.some(e => e.nip === data.nip && e.id !== data.id);
          if (isDup) return notify(`NIP ${data.nip} sudah ada`, 'error');
          await saveEmployee(data); await refreshData(); setIsModalOpen(false); notify('Berhasil disimpan', 'success');
        };
        const handleDelete = async () => { if(deleteId) { await deleteEmployee(deleteId); await refreshData(); setDeleteId(null); notify('Pegawai dihapus', 'success'); } };
        const handleExport = () => exportToExcel(filtered.map((e,i)=>({No:i+1, Nama:e.name, NIP:e.nip, Jabatan: positions.find(p=>p.id===e.positionId)?.name, Status: e.isActive?'Aktif':'Non'})), 'Data_Pegawai');
        const handleUpload = async (e) => {
          const file = e.target.files?.[0]; if(!file) return;
          try {
             const data = await readExcelFile(file);
             let s=0, f=0; const nips = new Set();
             for(const row of data) {
                if(!row['NIP']||!row['Nama']) { f++; continue; }
                const nip = row['NIP'].toString().trim();
                if(employees.some(e=>e.nip===nip) || nips.has(nip)) { f++; continue; }
                nips.add(nip);
                const pos = positions.find(p=>p.name.toLowerCase()===row['Nama Jabatan']?.toString().toLowerCase().trim());
                await saveEmployee({id: crypto.randomUUID(), nip, name: row['Nama'], positionId: pos?.id||'', isActive: row['Status']?.toLowerCase()==='aktif', createdAt: Date.now()});
                s++;
             }
             await refreshData(); notify(`${s} Sukses, ${f} Gagal`, s>0?'success':'error');
          } catch(err) { notify('Gagal upload', 'error'); }
          if(fileInputRef.current) fileInputRef.current.value='';
        };

        return (
          <div className="space-y-6">
            <div className="flex flex-col xl:flex-row justify-between gap-4"><h2 className="text-2xl font-bold">Data Pegawai</h2><div className="flex gap-2 flex-wrap"><button onClick={()=>exportToExcel([{NIP:'1990..',Nama:'Nama', 'Nama Jabatan':'Jafung', Status:'Aktif'}], 'Template_Pegawai')} className="border px-3 py-2 rounded flex gap-2 bg-white text-sm"><FileSpreadsheet size={18}/> Template</button><button onClick={()=>fileInputRef.current?.click()} className="bg-indigo-600 text-white px-3 py-2 rounded flex gap-2 text-sm"><Upload size={18}/> Upload</button><input type="file" ref={fileInputRef} className="hidden" onChange={handleUpload}/><button onClick={handleExport} className="bg-emerald-600 text-white px-3 py-2 rounded flex gap-2 text-sm"><Download size={18}/> Export</button><button onClick={()=>{setEditingEmp(null);setIsModalOpen(true)}} className="bg-blue-600 text-white px-3 py-2 rounded flex gap-2 text-sm"><Plus size={18}/> Tambah</button></div></div>
            <div className="bg-white p-4 rounded border flex gap-3"><Search className="text-gray-400"/><input className="flex-1 outline-none" placeholder="Cari NIP/Nama..." value={search} onChange={e=>setSearch(e.target.value)}/></div>
            <div className="bg-white rounded border overflow-hidden"><div className="overflow-y-auto max-h-[60vh]"><table className="w-full text-left"><thead className="bg-gray-50 text-xs uppercase"><tr><th className="p-4">Pegawai</th><th className="p-4">Jabatan</th><th className="p-4 text-center">Status</th><th className="p-4 text-center">Aksi</th></tr></thead><tbody className="text-sm divide-y">{paginated.map(e=>(<tr key={e.id} className="hover:bg-gray-50"><td className="p-4"><b>{e.name}</b><br/><span className="text-xs text-gray-500">{e.nip}</span></td><td className="p-4">{positions.find(p=>p.id===e.positionId)?.name}</td><td className="p-4 text-center"><span className={`px-2 py-1 rounded-full text-xs ${e.isActive?'bg-green-100 text-green-700':'bg-gray-100 text-gray-500'}`}>{e.isActive?'Aktif':'Non'}</span></td><td className="p-4 text-center flex justify-center gap-2"><button onClick={()=>{setEditingEmp(e);setIsModalOpen(true)}} className="text-blue-600 p-2 rounded hover:bg-blue-50"><Edit size={18}/></button><button onClick={()=>setDeleteId(e.id)} className="text-red-600 p-2 rounded hover:bg-red-50"><Trash2 size={18}/></button></td></tr>))}</tbody></table></div></div>
            <EmployeeForm isOpen={isModalOpen} initialData={editingEmp} positions={positions} onClose={()=>setIsModalOpen(false)} onSave={handleSave} />
            <ConfirmModal isOpen={!!deleteId} title="Hapus Pegawai?" message="Hapus pegawai akan menghapus data SK terkait." onConfirm={handleDelete} onCancel={()=>setDeleteId(null)} />
          </div>
        );
      };

      const SKManager = ({ notify }) => {
        const { sks, employees, ranks, refreshData } = useData();
        const [tab, setTab] = useState('PANGKAT');
        const [search, setSearch] = useState('');
        const [page, setPage] = useState(1);
        const [isModal, setIsModal] = useState(false);
        const [form, setForm] = useState({});
        const [delId, setDelId] = useState(null);
        const fileRef = useRef(null);
        useEffect(()=>setPage(1),[search,tab]);
        
        const filtered = sks.filter(s => s.type === tab && (s.number.includes(search) || employees.find(e=>e.id===s.employeeId)?.name.toLowerCase().includes(search.toLowerCase())));
        const paginated = filtered.slice((page-1)*10, page*10);

        const handleSave = async (e) => {
          e.preventDefault();
          await saveSK({ ...form, id: form.id||crypto.randomUUID(), type: tab, salary: Number(form.salary)||0, createdAt: Date.now() });
          await refreshData(); setIsModal(false); notify('SK Disimpan', 'success');
        };
        const handleDel = async () => { if(delId){ await deleteSK(delId); await refreshData(); setDelId(null); notify('SK Dihapus', 'success'); } };
        const handleUp = async (e) => {
           const f=e.target.files?.[0]; if(!f) return;
           const d = await readExcelFile(f);
           let s=0; 
           for(const r of d) {
             const emp = employees.find(x=>x.nip===r['NIP']?.toString());
             if(!emp || !r['No SK'] || !r['TMT']) continue;
             let rid = emp.rankId||'';
             if(tab==='PANGKAT') { const fr = ranks.find(rk=>rk.golongan===r['Golongan'] || rk.name===r['Nama Pangkat']); if(fr) rid=fr.id; }
             await saveSK({id: crypto.randomUUID(), type: tab, employeeId: emp.id, number: r['No SK'], rankId: rid, tmtDate: new Date(r['TMT']).toISOString().slice(0,10), date: new Date(r['Tanggal SK']||r['TMT']).toISOString().slice(0,10), salary: Number(r['Gaji'])||0, notes: r['Keterangan']||'', createdAt: Date.now()});
             s++;
           }
           await refreshData(); notify(`${s} Data Uploaded`, 'success');
           if(fileRef.current) fileRef.current.value='';
        };

        return (
          <div className="space-y-6">
            <div className="flex flex-col xl:flex-row justify-between gap-4"><h2 className="text-2xl font-bold">Manajemen SK</h2><div className="flex gap-2 flex-wrap"><button onClick={()=>exportToExcel([{NIP:'..','No SK':'..','Tanggal SK':'YYYY-MM-DD',TMT:'YYYY-MM-DD','Nama Pangkat':'..',Golongan:'..',Gaji:0,Keterangan:'..'}], 'Template_SK')} className="border px-3 py-2 bg-white rounded flex gap-2 text-sm"><FileSpreadsheet size={18}/> Template</button><button onClick={()=>fileRef.current?.click()} className="bg-indigo-600 text-white px-3 py-2 rounded flex gap-2 text-sm"><Upload size={18}/> Upload</button><input type="file" ref={fileRef} className="hidden" onChange={handleUp}/><button onClick={()=>exportToExcel(filtered.map((s,i)=>({No:i+1,'No SK':s.number,Pegawai:employees.find(e=>e.id===s.employeeId)?.name})), 'Data_SK')} className="bg-emerald-600 text-white px-3 py-2 rounded flex gap-2 text-sm"><Download size={18}/> Export</button><button onClick={()=>{setForm({tmtDate:'',date:'',salary:0,notes:''});setIsModal(true)}} className="bg-blue-600 text-white px-3 py-2 rounded flex gap-2 text-sm"><Plus size={18}/> Input SK</button></div></div>
            <div className="flex gap-2 border-b"><button onClick={()=>setTab('PANGKAT')} className={`px-4 py-2 border-b-2 flex gap-2 ${tab==='PANGKAT'?'border-blue-600 text-blue-600':'border-transparent'}`}><Award size={18}/> Pangkat</button><button onClick={()=>setTab('KGB')} className={`px-4 py-2 border-b-2 flex gap-2 ${tab==='KGB'?'border-emerald-600 text-emerald-600':'border-transparent'}`}><FileText size={18}/> KGB</button></div>
            <div className="bg-white p-4 rounded border flex gap-3"><Search className="text-gray-400"/><input className="flex-1 outline-none" placeholder="Cari SK/Pegawai..." value={search} onChange={e=>setSearch(e.target.value)}/></div>
            <div className="bg-white rounded border overflow-hidden"><div className="overflow-y-auto max-h-[60vh]"><table className="w-full text-left whitespace-nowrap"><thead className="bg-gray-50 text-xs uppercase"><tr><th className="p-4">SK</th><th className="p-4">Pegawai</th><th className="p-4">Pangkat</th><th className="p-4">TMT</th><th className="p-4">Gaji</th><th className="p-4 text-center">Aksi</th></tr></thead><tbody className="text-sm divide-y">{paginated.map(s=>(<tr key={s.id} className="hover:bg-gray-50"><td className="p-4"><b>{s.number}</b><br/><span className="text-xs text-gray-500">{formatDate(s.date)}</span></td><td className="p-4">{employees.find(e=>e.id===s.employeeId)?.name}</td><td className="p-4">{ranks.find(r=>r.id===s.rankId)?.golongan}</td><td className="p-4">{formatDate(s.tmtDate)}</td><td className="p-4">{formatCurrency(s.salary)}</td><td className="p-4 text-center flex justify-center gap-2"><button onClick={()=>{setForm(s);setIsModal(true)}} className="text-blue-600 p-2 hover:bg-blue-50 rounded"><Edit size={18}/></button><button onClick={()=>setDelId(s.id)} className="text-red-600 p-2 hover:bg-red-50 rounded"><Trash2 size={18}/></button></td></tr>))}</tbody></table></div></div>
            {isModal && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"><div className="bg-white rounded-xl w-full max-w-lg"><div className="p-4 border-b flex justify-between"><h3>Input SK {tab}</h3><button onClick={()=>setIsModal(false)}><X size={20}/></button></div><form onSubmit={handleSave} className="p-6 space-y-4 max-h-[80vh] overflow-y-auto"><div><label>Pegawai</label><select required className="w-full p-2 border rounded" value={form.employeeId||''} onChange={e=>{const em=employees.find(x=>x.id===e.target.value);setForm({...form,employeeId:e.target.value,rankId:em?.rankId})}}><option value="">-Pilih-</option>{employees.filter(e=>e.isActive).map(e=><option key={e.id} value={e.id}>{e.name} - {e.nip}</option>)}</select></div><div><label>No SK</label><input required className="w-full p-2 border rounded" value={form.number||''} onChange={e=>setForm({...form,number:e.target.value})}/></div><div className="grid grid-cols-2 gap-4"><div><label>Tgl SK</label><input type="date" required className="w-full p-2 border rounded" value={form.date||''} onChange={e=>setForm({...form,date:e.target.value})}/></div><div><label>TMT</label><input type="date" required className="w-full p-2 border rounded" value={form.tmtDate||''} onChange={e=>setForm({...form,tmtDate:e.target.value})}/></div></div><div className="grid grid-cols-2 gap-4"><div><label>Pangkat</label><select required className="w-full p-2 border rounded" value={form.rankId||''} onChange={e=>setForm({...form,rankId:e.target.value})}><option value="">-Pilih-</option>{ranks.map(r=><option key={r.id} value={r.id}>{r.golongan}</option>)}</select></div><div><label>Gaji</label><input type="number" required className="w-full p-2 border rounded" value={form.salary||''} onChange={e=>setForm({...form,salary:e.target.value})}/></div></div><textarea className="w-full p-2 border rounded" placeholder="Catatan" value={form.notes||''} onChange={e=>setForm({...form,notes:e.target.value})}/><button className="w-full py-2 bg-blue-600 text-white rounded">Simpan</button></form></div></div>)}
            <ConfirmModal isOpen={!!delId} title="Hapus SK?" message="Permanen." onConfirm={handleDel} onCancel={()=>setDelId(null)}/>
          </div>
        );
      };

      const MasterData = ({ type, notify }) => {
         const { positions, ranks, refreshData } = useData();
         const data = type==='JABATAN'?positions:ranks;
         const [editId, setEditId] = useState(null);
         const [form, setForm] = useState({});
         const [delId, setDelId] = useState(null);
         const fileRef = useRef(null);

         const handleSave = async () => {
           if(type==='JABATAN') await savePosition({id: editId==='NEW'?crypto.randomUUID():editId, name: form.name});
           else await saveRank({id: editId==='NEW'?crypto.randomUUID():editId, ...form});
           await refreshData(); setEditId(null); notify('Disimpan','success');
         };
         const handleDel = async () => { if(delId){ if(type==='JABATAN') await deletePosition(delId); else await deleteRank(delId); await refreshData(); setDelId(null); notify('Dihapus','success'); } };
         const handleUp = async (e) => {
           const f=e.target.files?.[0]; if(!f) return;
           const d = await readExcelFile(f);
           let c=0;
           for(const r of d) {
             if(type==='JABATAN' && r['Nama Jabatan']) { await savePosition({id:crypto.randomUUID(), name:r['Nama Jabatan']}); c++; }
             else if(type==='PANGKAT' && r['Nama Pangkat']) { await saveRank({id:crypto.randomUUID(), name:r['Nama Pangkat'], golongan:r['Golongan']}); c++; }
           }
           await refreshData(); notify(`${c} Data Uploaded`,'success');
           if(fileRef.current) fileRef.current.value='';
         };

         return (
           <div className="space-y-6">
             <div className="flex justify-between items-center"><h2 className="text-2xl font-bold">Master {type==='JABATAN'?'Jabatan':'Pangkat'}</h2><div className="flex gap-2"><button onClick={()=>exportToExcel([type==='JABATAN'?{'Nama Jabatan':'Example'}:{'Nama Pangkat':' Pembina',Golongan:'IV/a'}], 'Template')} className="border px-3 py-2 bg-white rounded flex gap-2 text-sm"><FileSpreadsheet size={18}/> Template</button><button onClick={()=>fileRef.current?.click()} className="bg-indigo-600 text-white px-3 py-2 rounded flex gap-2 text-sm"><Upload size={18}/> Upload</button><input type="file" ref={fileRef} className="hidden" onChange={handleUp}/><button onClick={()=>exportToExcel(data,'Master')} className="bg-emerald-600 text-white px-3 py-2 rounded flex gap-2 text-sm"><Download size={18}/> Export</button><button onClick={()=>{setEditId('NEW');setForm({})}} className="bg-blue-600 text-white px-3 py-2 rounded flex gap-2 text-sm"><Plus size={18}/> Tambah</button></div></div>
             <div className="bg-white rounded border overflow-hidden"><table className="w-full text-left"><thead className="bg-gray-50 text-xs uppercase"><tr><th className="p-4">Nama</th>{type==='PANGKAT'&&<th className="p-4">Golongan</th>}<th className="p-4 text-center">Aksi</th></tr></thead><tbody className="text-sm divide-y">
               {editId==='NEW' && <tr className="bg-blue-50"><td className="p-4"><input autoFocus className="w-full p-2 border rounded" placeholder="Nama" value={form.name||''} onChange={e=>setForm({...form,name:e.target.value})}/></td>{type==='PANGKAT'&&<td className="p-4"><input className="w-full p-2 border rounded" placeholder="Gol" value={form.golongan||''} onChange={e=>setForm({...form,golongan:e.target.value})}/></td>}<td className="p-4 text-center"><button onClick={handleSave}><Save size={18}/></button> <button onClick={()=>setEditId(null)}><X size={18}/></button></td></tr>}
               {data.map(item=>(<tr key={item.id} className="hover:bg-gray-50"><td className="p-4">{editId===item.id?<input className="w-full p-2 border rounded" value={form.name} onChange={e=>setForm({...form,name:e.target.value})}/>:item.name}</td>{type==='PANGKAT'&&<td className="p-4">{editId===item.id?<input className="w-full p-2 border rounded" value={form.golongan} onChange={e=>setForm({...form,golongan:e.target.value})}/>:<span className="bg-gray-100 px-2 py-1 rounded text-xs font-bold">{item.golongan}</span>}</td>}<td className="p-4 text-center flex justify-center gap-2">{editId===item.id?(<><button onClick={handleSave} className="text-emerald-600"><Save size={18}/></button><button onClick={()=>setEditId(null)} className="text-gray-500"><X size={18}/></button></>):(<><button onClick={()=>{setEditId(item.id);setForm(item)}} className="text-blue-600"><Edit size={18}/></button><button onClick={()=>setDelId(item.id)} className="text-red-600"><Trash2 size={18}/></button></>)}</td></tr>))}
             </tbody></table></div>
             <ConfirmModal isOpen={!!delId} title="Hapus?" message="Permanen." onConfirm={handleDel} onCancel={()=>setDelId(null)}/>
           </div>
         );
      };

      // --- APP LAYOUT & ROUTING ---
      
      const ToastContainer = ({ messages }) => (
        <div className="fixed top-4 right-4 z-[100] flex flex-col gap-2">{messages.map((m)=>(<div key={m.id} className={`flex gap-3 px-4 py-3 rounded shadow text-white animate-slide-in ${m.type==='success'?'bg-emerald-600':m.type==='error'?'bg-red-600':'bg-blue-600'}`}><span>{m.message}</span></div>))}</div>
      );

      const Layout = ({ children, userEmail }) => {
        const [sb, setSb] = useState(false);
        const { isLoading } = useData();
        const loc = useLocation();
        const navigate = useNavigate();
        
        const LinkItem = ({ to, icon, label }) => (<Link to={to} onClick={()=>setSb(false)} className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-colors ${loc.pathname===to?'bg-blue-600 text-white shadow-md':'text-gray-600 hover:bg-blue-50 hover:text-blue-600'}`}>{icon}<span className="font-medium">{label}</span></Link>);

        return (
          <div className="flex h-screen bg-gray-50 text-gray-900">
            {sb && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden" onClick={()=>setSb(false)}/>}
            <aside className={`fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white border-r transform transition-transform duration-200 ${sb?'translate-x-0':'-translate-x-full lg:translate-x-0'}`}>
               <div className="h-16 flex items-center px-6 border-b"><span className="text-xl font-bold text-blue-600">ASN Monitor</span></div>
               <nav className="p-4 space-y-1 overflow-y-auto h-[calc(100%-4rem-4rem)]">
                 <div className="px-4 py-2 text-xs font-semibold text-gray-400 uppercase">Menu</div>
                 <LinkItem to="/" icon={<LayoutDashboard size={18}/>} label="Dashboard"/>
                 <LinkItem to="/monitoring" icon={<BarChart2 size={18}/>} label="Monitoring"/>
                 <div className="mt-4 px-4 py-2 text-xs font-semibold text-gray-400 uppercase">Data</div>
                 <LinkItem to="/pegawai" icon={<Users size={18}/>} label="Pegawai"/>
                 <LinkItem to="/manajemen-sk" icon={<FolderOpen size={18}/>} label="Manajemen SK"/>
                 <div className="mt-4 px-4 py-2 text-xs font-semibold text-gray-400 uppercase">Master</div>
                 <LinkItem to="/master-jabatan" icon={<Briefcase size={18}/>} label="Jabatan"/>
                 <LinkItem to="/master-pangkat" icon={<Award size={18}/>} label="Pangkat"/>
               </nav>
               <div className="p-4 border-t"><button onClick={async()=>{await signOut();navigate('/login')}} className="flex items-center gap-3 px-4 py-3 w-full rounded-xl text-red-600 hover:bg-red-50"><LogOut size={18}/> Keluar</button></div>
            </aside>
            <main className="flex-1 flex flex-col h-screen overflow-hidden">
               <header className="h-16 bg-white border-b flex items-center justify-between px-4"><button onClick={()=>setSb(true)} className="lg:hidden p-2"><Menu/></button><div className="ml-auto flex items-center gap-4 text-sm">{userEmail} <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center">{userEmail?.[0].toUpperCase()}</div></div></header>
               <div className="flex-1 overflow-y-auto p-4 lg:p-8">{isLoading?<div className="flex h-full items-center justify-center"><Loader2 className="animate-spin w-10 h-10 text-blue-600"/></div>:children}</div>
            </main>
          </div>
        );
      };

      const App = () => {
        const [toasts, setToasts] = useState([]);
        const [session, setSession] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          supabase.auth.getSession().then(({ data: { session } }) => { setSession(session); setLoading(false); });
          const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => setSession(session));
          return () => subscription.unsubscribe();
        }, []);

        const notify = (message, type = 'info') => {
          const id = crypto.randomUUID();
          setToasts(p => [...p, { id, message, type }]);
          setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3000);
        };

        if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-50"><Loader2 className="w-10 h-10 text-blue-600 animate-spin" /></div>;

        return (
          <HashRouter>
            <Routes>
              <Route path="/login" element={!session ? <Login notify={notify} /> : <Navigate to="/" replace />} />
              <Route path="/register" element={!session ? <Register notify={notify} /> : <Navigate to="/" replace />} />
              <Route element={session ? <DataProvider><Outlet /></DataProvider> : <Navigate to="/login" replace />}>
                <Route path="*" element={
                  <Layout userEmail={session?.user?.email}>
                    <Routes>
                      <Route path="/" element={<Dashboard />} />
                      <Route path="/monitoring" element={<Monitoring />} />
                      <Route path="/pegawai" element={<EmployeeList notify={notify} />} />
                      <Route path="/manajemen-sk" element={<SKManager notify={notify} />} />
                      <Route path="/master-jabatan" element={<MasterData type="JABATAN" notify={notify} />} />
                      <Route path="/master-pangkat" element={<MasterData type="PANGKAT" notify={notify} />} />
                    </Routes>
                  </Layout>
                } />
              </Route>
            </Routes>
            <ToastContainer messages={toasts} />
          </HashRouter>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>