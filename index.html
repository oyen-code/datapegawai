<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Monitoring KGB & Pangkat ASN</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Sticky Header Logic */
        .table-container { max-height: 70vh; overflow: auto; }
        thead th { position: sticky; top: 0; z-index: 10; background-color: #f8fafc; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Transitions */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex">

    <!-- SIDEBAR -->
    <aside id="sidebar" class="bg-slate-900 text-white w-64 flex-shrink-0 hidden md:flex flex-col transition-all duration-300 z-50 absolute h-full md:relative">
        <div class="h-16 flex items-center px-6 border-b border-slate-700">
            <i class="fa-solid fa-user-shield text-blue-400 text-xl mr-3"></i>
            <span class="font-bold text-lg tracking-wide">MONITORING ASN</span>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <div class="px-4 text-xs font-semibold text-slate-400 uppercase mb-2">Utama</div>
            <a onclick="App.router('dashboard')" class="nav-link flex items-center px-6 py-3 hover:bg-slate-800 cursor-pointer text-slate-300 hover:text-white transition-colors border-l-4 border-transparent">
                <i class="fa-solid fa-chart-line w-6"></i> Dashboard
            </a>
            <a onclick="App.router('monitoring')" class="nav-link flex items-center px-6 py-3 hover:bg-slate-800 cursor-pointer text-slate-300 hover:text-white transition-colors border-l-4 border-transparent">
                <i class="fa-solid fa-clock w-6"></i> Monitoring Jadwal
            </a>

            <div class="px-4 text-xs font-semibold text-slate-400 uppercase mb-2 mt-6">Kepegawaian</div>
            <a onclick="App.router('pegawai')" class="nav-link flex items-center px-6 py-3 hover:bg-slate-800 cursor-pointer text-slate-300 hover:text-white transition-colors border-l-4 border-transparent">
                <i class="fa-solid fa-users w-6"></i> Data Pegawai
            </a>
            <a onclick="App.router('sk_kgb')" class="nav-link flex items-center px-6 py-3 hover:bg-slate-800 cursor-pointer text-slate-300 hover:text-white transition-colors border-l-4 border-transparent">
                <i class="fa-solid fa-money-bill-wave w-6"></i> Riwayat KGB
            </a>
            <a onclick="App.router('sk_pangkat')" class="nav-link flex items-center px-6 py-3 hover:bg-slate-800 cursor-pointer text-slate-300 hover:text-white transition-colors border-l-4 border-transparent">
                <i class="fa-solid fa-medal w-6"></i> Riwayat Pangkat
            </a>

            <div class="px-4 text-xs font-semibold text-slate-400 uppercase mb-2 mt-6">Master Data</div>
            <a onclick="App.router('master_jabatan')" class="nav-link flex items-center px-6 py-3 hover:bg-slate-800 cursor-pointer text-slate-300 hover:text-white transition-colors border-l-4 border-transparent">
                <i class="fa-solid fa-briefcase w-6"></i> Master Jabatan
            </a>
            <a onclick="App.router('master_pangkat')" class="nav-link flex items-center px-6 py-3 hover:bg-slate-800 cursor-pointer text-slate-300 hover:text-white transition-colors border-l-4 border-transparent">
                <i class="fa-solid fa-layer-group w-6"></i> Master Pangkat
            </a>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative">
        <!-- Header Mobile -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm md:hidden z-40">
            <span class="font-bold text-slate-800">SIMPEG MONITORING</span>
            <button onclick="document.getElementById('sidebar').classList.toggle('hidden')" class="text-slate-600">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </header>

        <!-- Content Area -->
        <div id="app-content" class="flex-1 overflow-auto p-4 md:p-8 relative">
            <!-- Dynamic Content injected here -->
        </div>
    </main>

    <!-- MODAL -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-100 fade-in">
            <div class="bg-slate-50 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold text-slate-800">Judul Modal</h3>
                <button onclick="UI.closeModal()" class="text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto">
                <!-- Form Content -->
            </div>
            <div class="bg-slate-50 px-6 py-4 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="UI.closeModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition">Batal</button>
                <button id="modal-save-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow transition">Simpan</button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-5 right-5 z-[60] transform translate-y-20 transition-transform duration-300">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3">
            <i class="fa-solid fa-check-circle text-green-400"></i>
            <span id="toast-message" class="text-sm font-medium">Berhasil disimpan</span>
        </div>
    </div>

    <script>
        /**
         * ==========================================
         * 1. CORE SYSTEM & DATABASE (LocalStorage)
         * ==========================================
         */
        const DB = {
            get: (key) => JSON.parse(localStorage.getItem(key)) || [],
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            
            init: () => {
                if(!localStorage.getItem('pegawai')) {
                    console.log("Seeding Initial Data...");
                    DB.set('master_jabatan', [
                        {id: 'j1', nama: 'Pranata Komputer Ahli Muda'},
                        {id: 'j2', nama: 'Analis Kepegawaian'},
                        {id: 'j3', nama: 'Guru Madya'}
                    ]);
                    DB.set('master_pangkat', [
                        {id: 'p1', pangkat: 'Penata Muda', gol: 'III/a'},
                        {id: 'p2', pangkat: 'Penata Muda Tk.I', gol: 'III/b'},
                        {id: 'p3', pangkat: 'Penata', gol: 'III/c'}
                    ]);
                    DB.set('pegawai', [
                        {id: '101', nip: '199001012015011001', nama: 'Budi Santoso', jabatanId: 'j1', pangkatId: 'p2'},
                        {id: '102', nip: '199205052019032005', nama: 'Siti Aminah', jabatanId: 'j2', pangkatId: 'p1'}
                    ]);
                    // History Seed
                    const today = new Date();
                    // Case 1: Mendekati KGB (2 tahun lalu - 1 bulan)
                    const tmtKgb = new Date(today.getFullYear()-2, today.getMonth()+1, 1).toISOString().split('T')[0];
                    DB.set('sk_kgb', [
                        {id: 'k1', pegawaiId: '101', no_sk: '800/KGB/01', tmt: tmtKgb, gaji: 3500000, tgl_sk: '2022-01-01', ket: 'KGB Berkala'}
                    ]);
                    // Case 2: Pangkat Aman
                    const tmtPangkat = new Date(today.getFullYear()-1, 0, 1).toISOString().split('T')[0];
                    DB.set('sk_pangkat', [
                        {id: 'pk1', pegawaiId: '101', no_sk: '820/KP/05', tmt: tmtPangkat, pangkatId: 'p2', tgl_sk: '2023-01-01', ket: 'Kenaikan Pangkat Reguler'}
                    ]);
                }
            }
        };

        /**
         * ==========================================
         * 2. LOGIC ENGINE (KGB & Pangkat Calc)
         * ==========================================
         */
        const Logic = {
            addMonths: (dateStr, months) => {
                const d = new Date(dateStr);
                d.setMonth(d.getMonth() + months);
                return d.toISOString().split('T')[0];
            },
            
            getStatus: (targetDateStr) => {
                const today = new Date();
                today.setHours(0,0,0,0);
                const target = new Date(targetDateStr);
                
                // Hitung selisih bulan
                const diffTime = target - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) return { label: 'Terlambat', color: 'bg-red-100 text-red-700 border-red-200', code: 'late' };
                if (diffDays <= 30 && diffDays >= 0) return { label: 'Jatuh Tempo', color: 'bg-orange-100 text-orange-700 border-orange-200', code: 'due' }; // Bulan ini
                if (diffDays <= 90) return { label: 'Mendekati', color: 'bg-yellow-100 text-yellow-700 border-yellow-200', code: 'near' }; // 3 bulan
                return { label: 'Aman', color: 'bg-green-100 text-green-700 border-green-200', code: 'safe' };
            },

            getAllMonitoringData: () => {
                const pegawai = DB.get('pegawai');
                const kgbHist = DB.get('sk_kgb');
                const pangHist = DB.get('sk_pangkat');
                let results = [];

                pegawai.forEach(p => {
                    // Cek KGB (Siklus 2 Tahun)
                    const lastKgb = kgbHist.filter(k => k.pegawaiId == p.id).sort((a,b) => b.tmt.localeCompare(a.tmt))[0];
                    if(lastKgb) {
                        const nextDate = Logic.addMonths(lastKgb.tmt, 24);
                        results.push({
                            pegawai: p, type: 'KGB', lastTmt: lastKgb.tmt, nextDate: nextDate, status: Logic.getStatus(nextDate)
                        });
                    }
                    
                    // Cek Pangkat (Siklus 4 Tahun)
                    const lastPang = pangHist.filter(k => k.pegawaiId == p.id).sort((a,b) => b.tmt.localeCompare(a.tmt))[0];
                    if(lastPang) {
                        const nextDate = Logic.addMonths(lastPang.tmt, 48);
                        results.push({
                            pegawai: p, type: 'Pangkat', lastTmt: lastPang.tmt, nextDate: nextDate, status: Logic.getStatus(nextDate)
                        });
                    }
                });
                return results;
            }
        };

        /**
         * ==========================================
         * 3. UI UTILITIES
         * ==========================================
         */
        const UI = {
            formatRupiah: (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(angka),
            formatDate: (date) => new Date(date).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}),
            
            showToast: (msg) => {
                const t = document.getElementById('toast');
                document.getElementById('toast-message').innerText = msg;
                t.classList.remove('translate-y-20');
                setTimeout(() => t.classList.add('translate-y-20'), 3000);
            },

            openModal: (title, html, onSave) => {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-body').innerHTML = html;
                
                const btn = document.getElementById('modal-save-btn');
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.onclick = () => {
                    if(onSave()) {
                        UI.closeModal();
                        UI.showToast('Data berhasil disimpan');
                    }
                };

                document.getElementById('modal').classList.remove('hidden');
            },

            closeModal: () => document.getElementById('modal').classList.add('hidden'),

            // Reusable Table Builder with Pagination
            renderTable: (config) => {
                const { id, columns, data, actions, page = 1, limit = 10 } = config;
                const start = (page - 1) * limit;
                let displayData = limit === 'all' ? data : data.slice(start, start + limit);
                
                let html = `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-full fade-in">
                    <div class="p-4 border-b border-slate-100 flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-slate-500">Show</span>
                            <select onchange="App.setLimit('${id}', this.value)" class="border rounded px-2 py-1 text-sm bg-slate-50">
                                <option value="10" ${limit==10?'selected':''}>10</option>
                                <option value="25" ${limit==25?'selected':''}>25</option>
                                <option value="50" ${limit==50?'selected':''}>50</option>
                                <option value="all" ${limit=='all'?'selected':''}>Semua</option>
                            </select>
                        </div>
                        <input type="text" placeholder="Cari data..." oninput="App.searchTable('${id}', this.value)" class="border rounded px-3 py-1.5 text-sm w-full md:w-64 focus:ring-2 focus:ring-blue-100 outline-none">
                    </div>
                    <div class="table-container flex-1">
                        <table class="w-full text-left border-collapse" id="table-${id}">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold tracking-wider">
                                <tr>
                                    ${columns.map(c => `<th class="px-6 py-3 whitespace-nowrap">${c}</th>`).join('')}
                                    ${actions ? '<th class="px-6 py-3 text-right">Aksi</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${displayData.length ? displayData.map(row => `
                                    <tr class="hover:bg-slate-50 transition-colors">
                                        ${row.cells.map(cell => `<td class="px-6 py-3 text-sm text-slate-700 whitespace-nowrap">${cell}</td>`).join('')}
                                        ${actions ? `<td class="px-6 py-3 text-right whitespace-nowrap">${actions(row.id)}</td>` : ''}
                                    </tr>
                                `).join('') : `<tr><td colspan="${columns.length + (actions?1:0)}" class="text-center py-8 text-slate-400">Tidak ada data</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 border-t border-slate-100 flex justify-between items-center text-sm text-slate-500">
                        <span>Menampilkan ${displayData.length} dari ${data.length} data</span>
                        <div class="flex gap-1">
                            <button onclick="App.setPage('${id}', ${page-1})" ${page<=1 ? 'disabled class="opacity-50 cursor-not-allowed"' : ''} class="px-3 py-1 border rounded hover:bg-slate-50">Prev</button>
                            <button onclick="App.setPage('${id}', ${page+1})" ${limit==='all' || start+limit >= data.length ? 'disabled class="opacity-50 cursor-not-allowed"' : ''} class="px-3 py-1 border rounded hover:bg-slate-50">Next</button>
                        </div>
                    </div>
                </div>`;
                return html;
            }
        };

        /**
         * ==========================================
         * 4. APP CONTROLLER
         * ==========================================
         */
        const App = {
            state: {
                page: 'dashboard',
                tables: {} // Store table pagination states
            },

            init: () => {
                DB.init();
                App.router('dashboard');
            },

            router: (page) => {
                App.state.page = page;
                
                // Update Sidebar Active State
                document.querySelectorAll('.nav-link').forEach(el => {
                    el.classList.remove('bg-slate-800', 'text-white', 'border-blue-500');
                    el.classList.add('text-slate-300', 'border-transparent');
                    if(el.getAttribute('onclick').includes(page)) {
                        el.classList.add('bg-slate-800', 'text-white', 'border-blue-500');
                        el.classList.remove('border-transparent', 'text-slate-300');
                    }
                });

                // Hide sidebar on mobile after click
                if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');

                const content = document.getElementById('app-content');
                content.innerHTML = ''; // Clear

                switch(page) {
                    case 'dashboard': App.renderDashboard(content); break;
                    case 'pegawai': App.renderPegawai(content); break;
                    case 'monitoring': App.renderMonitoring(content); break;
                    case 'sk_kgb': App.renderSK(content, 'kgb'); break;
                    case 'sk_pangkat': App.renderSK(content, 'pangkat'); break;
                    case 'master_jabatan': App.renderMaster(content, 'master_jabatan'); break;
                    case 'master_pangkat': App.renderMaster(content, 'master_pangkat'); break;
                }
            },

            // --- TABLE STATE HANDLERS ---
            setLimit: (id, val) => {
                if(!App.state.tables[id]) App.state.tables[id] = {page:1};
                App.state.tables[id].limit = val === 'all' ? 'all' : parseInt(val);
                App.state.tables[id].page = 1; // Reset to page 1
                App.router(App.state.page); // Re-render
            },
            setPage: (id, val) => {
                if(!App.state.tables[id]) App.state.tables[id] = {limit:10};
                App.state.tables[id].page = val;
                App.router(App.state.page);
            },
            searchTable: (id, term) => {
                const table = document.getElementById(`table-${id}`);
                const trs = table.getElementsByTagName('tr');
                for (let i = 1; i < trs.length; i++) {
                    const txt = trs[i].textContent.toLowerCase();
                    trs[i].style.display = txt.includes(term.toLowerCase()) ? '' : 'none';
                }
            },

            // --- RENDERERS ---

            renderDashboard: (container) => {
                const data = Logic.getAllMonitoringData();
                const pegawai = DB.get('pegawai').length;
                
                // Stats
                const thisMonth = new Date().getMonth();
                const thisYear = new Date().getFullYear();
                
                const kgbMonth = data.filter(x => x.type === 'KGB' && new Date(x.nextDate).getMonth() === thisMonth && new Date(x.nextDate).getFullYear() === thisYear).length;
                const pangYear = data.filter(x => x.type === 'Pangkat' && new Date(x.nextDate).getFullYear() === thisYear).length;
                const late = data.filter(x => x.status.code === 'late').length;

                // Chart Data (KGB per month)
                const monthCounts = Array(12).fill(0);
                data.filter(x => x.type === 'KGB' && new Date(x.nextDate).getFullYear() === thisYear).forEach(x => {
                    monthCounts[new Date(x.nextDate).getMonth()]++;
                });

                container.innerHTML = `
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Dashboard Ikhtisar</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                            <p class="text-xs text-slate-500 uppercase font-bold">Total Pegawai</p>
                            <p class="text-3xl font-bold text-slate-800 mt-2">${pegawai}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500">
                            <p class="text-xs text-slate-500 uppercase font-bold">KGB Bulan Ini</p>
                            <p class="text-3xl font-bold text-slate-800 mt-2">${kgbMonth}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500">
                            <p class="text-xs text-slate-500 uppercase font-bold">Naik Pangkat (Thn Ini)</p>
                            <p class="text-3xl font-bold text-slate-800 mt-2">${pangYear}</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                            <p class="text-xs text-slate-500 uppercase font-bold">Terlambat Proses</p>
                            <p class="text-3xl font-bold text-red-600 mt-2">${late}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-96">
                        <div class="bg-white p-6 rounded-xl shadow-sm lg:col-span-2 flex flex-col">
                            <h3 class="font-bold text-slate-700 mb-4">Grafik KGB Tahun ${thisYear}</h3>
                            <div class="flex-1 relative"><canvas id="kgbChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm flex flex-col">
                            <h3 class="font-bold text-slate-700 mb-4">Status Mendesak (Top 5)</h3>
                            <div class="flex-1 overflow-auto space-y-3">
                                ${data.filter(x => x.status.code === 'late' || x.status.code === 'due').slice(0, 5).map(x => `
                                    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-50 border border-slate-100">
                                        <div>
                                            <p class="font-semibold text-sm text-slate-800">${x.pegawai.nama}</p>
                                            <p class="text-xs text-slate-500">${x.type} - ${UI.formatDate(x.nextDate)}</p>
                                        </div>
                                        <span class="text-xs font-bold px-2 py-1 rounded ${x.status.color}">${x.status.label}</span>
                                    </div>
                                `).join('') || '<p class="text-sm text-slate-400 text-center mt-10">Tidak ada data mendesak.</p>'}
                            </div>
                        </div>
                    </div>
                `;

                // Render Chart
                new Chart(document.getElementById('kgbChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agust', 'Sep', 'Okt', 'Nov', 'Des'],
                        datasets: [{ label: 'Jadwal KGB', data: monthCounts, backgroundColor: '#3b82f6', borderRadius: 4 }]
                    },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: {stepSize:1} } } }
                });
            },

            renderPegawai: (container) => {
                const list = DB.get('pegawai');
                const mJab = DB.get('master_jabatan');
                const mPang = DB.get('master_pangkat');
                const state = App.state.tables['pegawai'] || {page:1, limit:10};

                const header = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Data Pegawai ASN</h2>
                        <button onclick="App.modalPegawai()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow flex items-center gap-2"><i class="fa-solid fa-plus"></i> Tambah</button>
                    </div>`;
                
                const tableData = list.map(p => ({
                    id: p.id,
                    cells: [
                        `<div class="font-mono font-medium">${p.nip}</div>`,
                        `<div class="font-semibold">${p.nama}</div>`,
                        mJab.find(j => j.id == p.jabatanId)?.nama || '-',
                        `<span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold border border-slate-200">${mPang.find(pg => pg.id == p.pangkatId)?.gol || '-'}</span>`
                    ]
                }));

                const actions = (id) => `
                    <button onclick="App.deleteItem('pegawai', '${id}')" class="text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 p-2 rounded transition"><i class="fa-solid fa-trash-alt"></i></button>
                `;

                container.innerHTML = header + UI.renderTable({ id: 'pegawai', columns: ['NIP', 'Nama', 'Jabatan', 'Golongan'], data: tableData, actions, page: state.page, limit: state.limit });
            },

            renderSK: (container, type) => {
                const dbKey = type === 'kgb' ? 'sk_kgb' : 'sk_pangkat';
                const list = DB.get(dbKey).sort((a,b) => b.tmt.localeCompare(a.tmt)); // Sort desc TMT
                const peg = DB.get('pegawai');
                const mPang = DB.get('master_pangkat');
                const state = App.state.tables[dbKey] || {page:1, limit:10};

                const title = type === 'kgb' ? 'Kenaikan Gaji Berkala (KGB)' : 'Kenaikan Pangkat';
                
                const header = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Riwayat ${title}</h2>
                        <button onclick="App.modalSK('${type}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow flex items-center gap-2"><i class="fa-solid fa-file-circle-plus"></i> Input SK Baru</button>
                    </div>`;

                const tableData = list.map(item => {
                    const p = peg.find(x => x.id == item.pegawaiId);
                    const val = type === 'kgb' ? UI.formatRupiah(item.gaji) : (mPang.find(x => x.id == item.pangkatId)?.gol || item.pangkatId);
                    return {
                        id: item.id,
                        cells: [
                            `<div class="font-medium">${p ? p.nama : 'Unknown'}</div><div class="text-xs text-slate-500">${p?.nip||''}</div>`,
                            item.no_sk,
                            `<div class="text-blue-600 font-mono font-bold">${UI.formatDate(item.tmt)}</div>`,
                            val,
                            UI.formatDate(item.tgl_sk)
                        ]
                    };
                });

                const actions = (id) => `<button onclick="App.deleteItem('${dbKey}', '${id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fa-solid fa-trash"></i></button>`;
                
                container.innerHTML = header + UI.renderTable({ 
                    id: dbKey, 
                    columns: ['Pegawai', 'No. SK', 'TMT (Terhitung Mulai)', type==='kgb'?'Gaji Baru':'Pangkat Baru', 'Tgl SK'], 
                    data: tableData, actions, page: state.page, limit: state.limit 
                });
            },

            renderMonitoring: (container) => {
                let data = Logic.getAllMonitoringData();
                const state = App.state.tables['monitor'] || {page:1, limit:10};

                // Filter UI Logic would go here (simplified for single file)
                // Filter by year/month if requested in UI inputs
                
                // Sorting: Terlambat & Jatuh Tempo First
                const priority = { 'late': 1, 'due': 2, 'near': 3, 'safe': 4 };
                data.sort((a,b) => priority[a.status.code] - priority[b.status.code]);

                const header = `<h2 class="text-2xl font-bold text-slate-800 mb-6">Monitoring Jadwal</h2>`;

                const tableData = data.map(item => ({
                    id: item.pegawai.id + item.type, // Fake ID
                    cells: [
                        `<div class="font-bold">${item.pegawai.nama}</div><div class="text-xs text-slate-500">${item.pegawai.nip}</div>`,
                        `<span class="px-2 py-1 rounded text-xs font-bold ${item.type==='KGB'?'bg-blue-50 text-blue-600':'bg-indigo-50 text-indigo-600'}">${item.type}</span>`,
                        UI.formatDate(item.lastTmt),
                        `<div class="font-bold text-slate-700">${UI.formatDate(item.nextDate)}</div>`,
                        `<span class="px-3 py-1 rounded-full text-xs font-bold border ${item.status.color}">${item.status.label}</span>`
                    ]
                }));

                container.innerHTML = header + UI.renderTable({
                    id: 'monitor',
                    columns: ['Pegawai', 'Jenis', 'TMT Terakhir', 'Jadwal Berikutnya', 'Status'],
                    data: tableData,
                    page: state.page, limit: state.limit
                });
            },

            renderMaster: (container, key) => {
                const title = key === 'master_jabatan' ? 'Jabatan' : 'Pangkat/Golongan';
                const list = DB.get(key);
                const state = App.state.tables[key] || {page:1, limit:10};

                const header = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Master ${title}</h2>
                        <button onclick="App.modalMaster('${key}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">+ Tambah</button>
                    </div>`;

                const columns = key === 'master_jabatan' ? ['Nama Jabatan'] : ['Pangkat', 'Golongan'];
                const tableData = list.map(item => ({
                    id: item.id,
                    cells: key === 'master_jabatan' ? [item.nama] : [item.pangkat, item.gol]
                }));

                const actions = (id) => `<button onclick="App.deleteItem('${key}', '${id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i class="fa-solid fa-trash"></i></button>`;

                container.innerHTML = header + UI.renderTable({ id: key, columns, data: tableData, actions, page: state.page, limit: state.limit });
            },

            // --- FORM LOGIC ---

            modalPegawai: () => {
                const jabs = DB.get('master_jabatan').map(x => `<option value="${x.id}">${x.nama}</option>`).join('');
                const pangs = DB.get('master_pangkat').map(x => `<option value="${x.id}">${x.gol} - ${x.pangkat}</option>`).join('');
                
                const html = `
                    <form id="form-generic" class="space-y-4">
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">NIP</label><input required name="nip" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Nama Lengkap</label><input required name="nama" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Jabatan</label><select name="jabatanId" class="w-full border rounded-lg px-3 py-2 bg-white">${jabs}</select></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Pangkat</label><select name="pangkatId" class="w-full border rounded-lg px-3 py-2 bg-white">${pangs}</select></div>
                    </form>`;
                
                UI.openModal('Tambah Pegawai', html, () => {
                    const form = document.getElementById('form-generic');
                    if(!form.checkValidity()) return alert('Mohon lengkapi data');
                    const data = Object.fromEntries(new FormData(form));
                    data.id = Date.now().toString();
                    const list = DB.get('pegawai');
                    list.push(data);
                    DB.set('pegawai', list);
                    App.router('pegawai');
                    return true;
                });
            },

            modalSK: (type) => {
                const pegOptions = DB.get('pegawai').map(p => `<option value="${p.id}">${p.nama} (${p.nip})</option>`).join('');
                const extraField = type === 'kgb' 
                    ? `<div><label class="block text-sm font-medium text-slate-700 mb-1">Gaji Baru (Rp)</label><input type="number" required name="gaji" class="w-full border rounded-lg px-3 py-2"></div>`
                    : `<div><label class="block text-sm font-medium text-slate-700 mb-1">Pangkat Baru</label><select name="pangkatId" class="w-full border rounded-lg px-3 py-2 bg-white">${DB.get('master_pangkat').map(x=>`<option value="${x.id}">${x.gol}</option>`).join('')}</select></div>`;
                
                const html = `
                    <form id="form-generic" class="space-y-4">
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Pilih Pegawai</label><select name="pegawaiId" class="w-full border rounded-lg px-3 py-2 bg-white">${pegOptions}</select></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-slate-700 mb-1">Nomor SK</label><input required name="no_sk" class="w-full border rounded-lg px-3 py-2"></div>
                            <div><label class="block text-sm font-medium text-slate-700 mb-1">Tanggal SK</label><input type="date" required name="tgl_sk" class="w-full border rounded-lg px-3 py-2"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">TMT (Terhitung Mulai)</label>
                            <input type="date" required name="tmt" class="w-full border rounded-lg px-3 py-2 border-blue-300">
                            <p class="text-xs text-blue-500 mt-1">*Menentukan jadwal kenaikan berikutnya</p>
                        </div>
                        ${extraField}
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Keterangan</label><textarea name="ket" class="w-full border rounded-lg px-3 py-2" rows="2"></textarea></div>
                    </form>`;

                UI.openModal(`Input SK ${type.toUpperCase()}`, html, () => {
                    const form = document.getElementById('form-generic');
                    if(!form.checkValidity()) return alert('Lengkapi data wajib');
                    const data = Object.fromEntries(new FormData(form));
                    if(!data.tmt) return alert('TMT Wajib diisi');
                    
                    data.id = Date.now().toString();
                    const key = type === 'kgb' ? 'sk_kgb' : 'sk_pangkat';
                    const list = DB.get(key);
                    list.push(data);
                    DB.set(key, list);
                    
                    // Update current rank in employee data if rank upgrade
                    if(type === 'pangkat') {
                        const pegs = DB.get('pegawai');
                        const pIndex = pegs.findIndex(p => p.id == data.pegawaiId);
                        if(pIndex > -1) {
                            pegs[pIndex].pangkatId = data.pangkatId;
                            DB.set('pegawai', pegs);
                        }
                    }

                    App.router(`sk_${type}`);
                    return true;
                });
            },

            modalMaster: (key) => {
                const isJab = key === 'master_jabatan';
                const fields = isJab 
                    ? `<div><label class="block text-sm font-medium text-slate-700">Nama Jabatan</label><input required name="nama" class="w-full border rounded px-3 py-2"></div>`
                    : `<div><label class="block text-sm font-medium text-slate-700">Pangkat</label><input required name="pangkat" class="w-full border rounded px-3 py-2 mb-2"></div>
                       <div><label class="block text-sm font-medium text-slate-700">Golongan (cth: III/a)</label><input required name="gol" class="w-full border rounded px-3 py-2"></div>`;
                
                const html = `<form id="form-generic" class="space-y-4">${fields}</form>`;
                
                UI.openModal('Tambah Master', html, () => {
                    const form = document.getElementById('form-generic');
                    if(!form.checkValidity()) return alert('Isi semua field');
                    const data = Object.fromEntries(new FormData(form));
                    data.id = Date.now().toString();
                    
                    // Validation duplicate
                    const list = DB.get(key);
                    if(isJab && list.find(x => x.nama.toLowerCase() === data.nama.toLowerCase())) return alert('Jabatan sudah ada');
                    if(!isJab && list.find(x => x.gol === data.gol)) return alert('Golongan sudah ada');

                    list.push(data);
                    DB.set(key, list);
                    App.router(key);
                    return true;
                });
            },

            deleteItem: (key, id) => {
                if(confirm('Yakin ingin menghapus data ini?')) {
                    const list = DB.get(key).filter(x => x.id !== id);
                    DB.set(key, list);
                    App.router(App.state.page); // Refresh
                    UI.showToast('Data dihapus');
                }
            }
        };

        // START
        window.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>